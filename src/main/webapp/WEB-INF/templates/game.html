<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
        <!-- Add icon library -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <title>Tic-Tac-Toe</title>
        <style type="text/css">
            div { margin: 5px;}
            table{ table-layout:fixed; }
            td.tttField {
                width:70px;
                height:70px;
                max-width:150px;
                max-height:150px;
                min-width:50px;
                min-height:50px;
                text-align: center;
                font-family: "Arial";
                font-size: 36px;
                cursor: pointer;
            }
            td.tttField:hover {
                background-color: Aquamarine;
            }
        </style>
        <!-- Optional JavaScript -->
        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

    </head>
<body>
    <div class="container">
        <h1>Tic-Tac-Toe - Neural Network Test</h1>

        <div class="row">
            <div class="col-3">
                <table>
                    <tr>
                        <td class="tttField border border-0" id="0_0"></td>
                        <td class="tttField border border-top-0" id="0_1"></td>
                        <td class="tttField border border-0" id="0_2"></td>
                    </tr>
                    <tr>
                        <td class="tttField border border-left-0" id="1_0"></td>
                        <td class="tttField border" id="1_1"></td>
                        <td class="tttField border border-right-0" id="1_2"></td>
                    </tr>
                    <tr>
                        <td class="tttField border border-0" id="2_0"></td>
                        <td class="tttField border border-bottom-0" id="2_1"></td>
                        <td class="tttField border border-0" id="2_2"></td>
                    </tr>
                </table>
            </div>
            <div class="col-4">
                <div class="row">
                    <div class="col">
                        <button class="btn-sm btn-primary" type="button" onclick="resetGame()">New game</button>
                        <button class="btn-sm btn-primary" type="button" onclick="getComputerMove()">Computer starts</button>
                    </div>
                </div>
            </div>
        </div>

        <!--Copyright-->
        <div class="footer-copyright py-3">
            Â© 2020 Copyright: Slawomir Korbas
        </div>
    </div>
    
    <script>
        var boardDto = null;
        var userFigure = 'o';

        $(".tttField").click(function() {
            var cords = $(this).attr('id').split("_");
            if( boardDto.board[parseInt(cords[0])][parseInt(cords[1])].trim() == "" &&
                boardDto.result == null)
            {
                boardDto.board[parseInt(cords[0])][parseInt(cords[1])] = userFigure;
                updateBoard(boardDto);
                getComputerMove();
                delay(200);
            }
        });

        function getComputerMove() {
            sendBoardState(boardDto, userFigure, function (dto) {
                boardDto = dto;
                updateBoard(boardDto);
                //console.log("New game state is: " + JSON.stringify(boardDto));
                if (boardDto.result != null) {
                    console.log("Game is over. Computer " + boardDto.result + " !");
                }
            });
        }

        function resetGame()
        {
            getNewBoard(function(emptyboardDto){
                boardDto = emptyboardDto;
                console.log("New game started. Game state is: " + JSON.stringify(boardDto));
                updateBoard(emptyboardDto);
            });
        }

        function updateBoard(boardDto)
        {
            $("#0_0").html(boardDto.board[0][0]);
            $("#0_1").html(boardDto.board[0][1]);
            $("#0_2").html(boardDto.board[0][2]);
            $("#1_0").html(boardDto.board[1][0]);
            $("#1_1").html(boardDto.board[1][1]);
            $("#1_2").html(boardDto.board[1][2]);
            $("#2_0").html(boardDto.board[2][0]);
            $("#2_1").html(boardDto.board[2][1]);
            $("#2_2").html(boardDto.board[2][2]);

            if(boardDto.result != null) {
                //TODO mark inline figures with different colour
            }
        }

        function getNewBoard(callback) {
            $.get( "/tictactoe/newBoard", function(data) {
                callback(data);
            });
        }

        function sendBoardState(boardDto, userFigure, callback) {
            var url = "/tictactoe/predict?userFigure=" + userFigure;
            $.ajax({
                url: url,
                type: "POST",
                data: JSON.stringify(boardDto),
                contentType:"application/json; charset=utf-8",
                dataType:"json",
                success: function(data){
                    callback(data);
                }
            });
        }
        
        function delay(milliseconds) {
            const date = Date.now();
            let currentDate = null;
            do {
                currentDate = Date.now();
            } while (currentDate - date < milliseconds);
        }

        $( document ).ready(function() {
            resetGame();
            console.log("Ready to play new game!")
        });
    </script>

</body>
</html>